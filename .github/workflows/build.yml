on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build_and_test:
    name: Build and test
    runs-on: ubuntu-latest
    steps:
      # There's two different checkout steps; one runs from main, the other runs
      # from a pull_request. The difference is that when running from a PR, we might
      # want to push changes to cabal files, hence we need to set up the ref.
      - name: Check out repository code (from PR).
        if: github.ref != 'refs/heads/main'
        uses: actions/checkout@v2
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Check out repository code (from main).
        if: github.ref == 'refs/heads/main'
        uses: actions/checkout@v2
      ########
      ########
      - name: Install nix.
        uses: cachix/install-nix-action@v13
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      # Would using cachix help in anyway? I think we are not building anything, we're
      # only fetching things from cache.nixos.org and iohk.cachix.org
      # - uses: cachix/cachix-action@v10
      #   with:
      #     name: twaudit-libs
      #     authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      - name: Accessing the cabal cache.
        uses: actions/cache@v2
        with:
          path: |
            ~/.cabal/store
            dist-newstyle
          key: cabal-cache-${{ github.sha }}
          restore-keys: |
            cabal-cache
      - name: Chmod test script.
        run: |
          chmod u+x ci/run-tests.sh
          chmod u+x ci/commit-and-push-cabal-changes.sh
      - name: Build and test.
        run: |
          nix-shell --run "./ci/run-tests.sh --ci" --allowed-uris 'https://github.com/NixOS/nixpkgs https://github.com/input-output-hk https://github.com/NixOS/nixpkgs-channels' --option trusted-public-keys "hydra.iohk.io:f/Ea+s+dFdN+3Y/G+FDgSq+a5NEWhJGzdjvKNGv0/EQ= iohk.cachix.org-1:DpRUyj7h7V830dp/i6Nti+NEO2/nhblbov/8MW7Rqoo= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=" --option substituters "https://hydra.iohk.io https://iohk.cachix.org https://cache.nixos.org/" nix/ci.nix
      - name: Commit and push cabal files if necessary
        if: success() && github.ref != 'refs/heads/main'
        run: ci/commit-and-push-cabal-changes.sh
