---

name: Publish documentation

## We run this workflow for all pushes on `main`, for all tag pushes *and* for
## all pull requests. This allows checking that documentation builds correctly
## before merging anything. Of course, the actual deployment of the
## documentation only happens on the `main` branch.
on:
  push:
    branches:
      - main
    tags:
      - '*'
  pull_request:

## REVIEW: Why do we need this?
permissions:
  contents: write

jobs:

  publish-documentation:
    name: Documentation

    runs-on: ubuntu-latest

    steps:
      - name: Check out repository code
        uses: actions/checkout@v3.3.0

      - name: Install Nix
        uses: cachix/install-nix-action@v19
        with:
          extra_nix_config: |
            ## Access token to avoid triggering GitHub's rate limiting.
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

      - name: Setup Nix caches
        uses: cachix/cachix-action@v12
        with:
          name: tweag-plutus-libs
          ## No auth token: read only cache.

      ## Example from
      ## https://github.com/actions/cache/blob/ac25611caef967612169ab7e95533cf932c32270/examples.md#haskell---cabal
      - name: Accessing the Cabal cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cabal/packages
            ~/.cabal/store
            dist-newstyle
          key: ${{ runner.os }}-${{ hashFiles('**/*.cabal', '**/cabal.project', '**/cabal.project.freeze') }}
          restore-keys: ${{ runner.os }}-

      - name: Build documentation
        run: |
          nix develop .#ci --command bash -c '
            set -o xtrace

            cabal update

            cabal haddock \
              --haddock-hyperlink-source \
              --haddock-html-location="http://hackage.haskell.org/packages/archive/\$pkg/latest/doc/html" \
              cooked-validators

            mkdir -p docs
            cp --force --recursive dist-newstyle/build/*/ghc-*/cooked-validators-*/doc/html/cooked-validators/* docs
          '

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        if: ${{ github.ref == 'refs/heads/main' }}
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
